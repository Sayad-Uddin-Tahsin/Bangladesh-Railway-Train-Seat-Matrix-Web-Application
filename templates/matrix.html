<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix | Segmented Seat Matrix</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon"
        href="https://raw.githubusercontent.com/nishatrhythm/Bangladesh-Railway-Train-and-Fare-List-with-Route-Map/main/images/bangladesh-railway.png">
</head>

<body>
    <div class="flyout-notification" id="flyoutNotification">
        <span id="flyoutMessage"></span>
        <i class="fas fa-times flyout-close" id="flyoutClose"></i>
    </div>
    <!-- Language Toggle Button -->
    <button id="langToggleBtn" class="lang-toggle-btn" type="button" aria-label="Switch Language">
        <i class="fa fa-language" aria-hidden="true"></i>
        <span class="lang-toggle-text" id="langToggleText">বাংলা</span>
        <span class="lang-toggle-mobile-label" id="langToggleMobileLabel">A</span>
    </button>
    <noscript>
        <div class="matrix-container noscript-warning">
            <h2><i class="fas fa-exclamation-circle"></i> Please Enable JavaScript</h2>
            <p>This website requires JavaScript to function properly. Enable it in your browser settings to access full
                functionality and check train seat availability.</p>
            <div class="instructions">
                <strong>How to enable:</strong> Go to your browser settings > Privacy/Security > Enable JavaScript.
                Refresh the page after enabling.
            </div>
        </div>
    </noscript>

    <div class="matrix-container">
        <h1><i class="fas fa-th-list"></i> <span class="translatable" data-bn="সিট ম্যাট্রিক্স: ">{{ train_name }}</span>
        </h1>

        <a href="/" class="btn-primary translatable" data-bn="অনুসন্ধানে ফিরে যান">
            <i class="fas fa-arrow-left"></i> Back to Search
        </a>

        <div class="date-header">
            <h2 class="translatable" data-bn="ভ্রমণের তারিখ:"><i class="fas fa-calendar-alt"></i> Journey Date: {{ date }}</h2>
            {% if has_segmented_dates %}
            <div class="travel-alert">
                <div class="alert-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3 class="translatable" data-bn="ওভারনাইট জার্নির জন্য তারিখ নির্বাচন">Date Selection for Overnight Journey</h3>
                </div>
                <p class="translatable" data-bn="এই ট্রেনটি {{ date }} তারিখে যাত্রা শুরু করে, কিন্তু কিছু স্টেশনে মধ্যরাতের পরে পৌঁছায় — অর্থাৎ {{ next_day_str }} তারিখের প্রথম প্রহরে। ঐ স্টেশনগুলোর টিকিট {{ next_day_str }} তারিখে পাওয়া যেতে পারে।">This train departs from its origin station on {{ date }}, but reaches certain stations after midnight
                    — in the early hours of {{ next_day_str }}. Ticket availability for those post-midnight arrivals may
                    appear under {{ next_day_str }}.</p>
                <div class="alert-tip">
                    <i class="fas fa-lightbulb"></i>
                    <p class="translatable" data-bn="{{ date }} তারিখের প্রথম প্রহরে পৌঁছানোর টিকিট পেতে চাইলে, অনুসন্ধান করুন {{ prev_day_str }} তারিখ দিয়ে।">Tip: To find tickets for arrivals early on {{ date }}, try searching with {{ prev_day_str }} as your
                        journey date.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="route-card route-visualization-card">
            <details class="route-collapse">
                <summary class="route-toggle-btn">
                    <span class="route-toggle-text translatable" data-bn="ট্রেন রুট দেখুন"><i class="fas fa-route"></i> Expand to view Train Route</span>
                    <i class="fas fa-chevron-down toggle-arrow"></i>
                </summary>

                <div class="route-body">
                    <div class="route-train-header">
                        <h3><i class="fas fa-subway"></i> {{ train_name }}</h3>
                        <div class="run-days-list">
                            <span class="run-days-title">Runs on:</span>
                            {% for day in ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'] %}
                            <span class="run-day {% if day not in days %}off{% endif %}">
                                {{ day }}{% if day not in days %}<sup>(off)</sup>{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="station-timeline">
                        {% for stop in routes %}
                        <div class="station-item {% if loop.first %}start{% elif loop.last %}end{% endif %}">
                            <div class="station-node">
                                <div class="station-icon-circle">
                                    <i class="fas fa-location-dot"></i>
                                </div>
                                {% if not loop.last %}
                                <div class="station-line"></div>
                                {% endif %}
                            </div>
                            <div class="station-info">
                                <div class="station-header">
                                    <div class="station-name">
                                        {{ stop.city }}
                                        {% if stop.display_date %}
                                        <span class="station-date">{{ stop.display_date }}</span>
                                        {% endif %}
                                    </div>
                                    {% if loop.first %}
                                    <span class="station-type-label start">Origin</span>
                                    {% elif loop.last %}
                                    <span class="station-type-label end">Destination</span>
                                    {% endif %}
                                </div>
                                <div class="station-meta-row">
                                    <div class="meta-item">
                                        <strong>Arrival:</strong>
                                        {% if stop.arrival_time %}
                                        {{ stop.arrival_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Departure:</strong>
                                        {% if stop.departure_time %}
                                        {{ stop.departure_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Halt:</strong>
                                        {% if stop.halt and stop.halt != '---' %}
                                        {{ stop.halt|int }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Duration:</strong>
                                        {% if stop.duration and stop.duration != '---' %}
                                        {% set hours, minutes = stop.duration.split(':') %}
                                        {% set h = hours|int %}
                                        {% set m = minutes|int %}
                                        {% if h > 0 and m > 0 %}
                                        {{ h }} h {{ m }} min
                                        {% elif h > 0 %}
                                        {{ h }} h
                                        {% elif m > 0 %}
                                        {{ m }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="total-journey-time translatable" data-bn="মোট সময়:"><i class="fas fa-clock"></i> Total Duration:
                        {% if total_duration %}
                        {% set hours, minutes = total_duration.split(':') %}
                        {% set h = hours|int %}
                        {% set m = minutes|int %}
                        {% if h > 0 and m > 0 %}
                        {{ h }} h {{ m }} min
                        {% elif h > 0 %}
                        {{ h }} h
                        {% else %}
                        {{ m }} min
                        {% endif %}
                        {% else %}
                        ———
                        {% endif %}
                    </div>
                </div>
            </details>
        </div>

        {% for seat_type in seat_types %}
        {% if has_data_map[seat_type] %}
        {% set matrix = fare_matrices[seat_type] %}
        <div class="matrix-card">
            <h3 class="translatable" data-bn="আসন ধরন:"><i class="fas fa-chair"></i> Seat Type: {{ seat_type }}</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="translatable" data-bn="থেকে → পর্যন্ত">From → To</th>
                            {% for col in stations %}<th>{{ col }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for from_station in stations %}
                        <tr>
                            <td><strong>{{ from_station }}</strong></td>
                            {% for to_station in stations %}
                            {% if stations.index(from_station) >= stations.index(to_station) %}
                            <td class="disabled-cell"></td>
                            {% else %}
                            {% set cell = matrix[from_station].get(to_station) %}
                            {% if cell and (cell.online + cell.offline) > 0 %}
                            {# Convert station_dates[from_station] (YYYY-MM-DD) to DD-MMM-YYYY #}
                            {% set doj = station_dates_formatted.get(from_station, date) %}
                            <td class="available">
                                <div class="cell-content">
                                    <span class="seat-count">{{ cell.online + cell.offline }}</span>
                                    <span class="fare"><span class="taka-icon">৳</span><span class="fare-value">{{
                                            (cell.fare + cell.vat_amount) | int }}</span></span>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity={{ from_station }}&tocity={{ to_station }}&doj={{ doj }}&class={{ seat_type }}"
                                        class="buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </td>
                            {% else %}
                            <td class="disabled-cell"></td>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <div class="ca-check-availability-section">
            <h2><i class="fas fa-search"></i> Check Ticket Availability</h2>
            <form id="ca-availability-form" class="ca-availability-form">
                <div class="ca-form-row">
                    <div class="ca-form-group">
                        <label for="ca-origin-station-input" class="translatable" data-bn="যাত্রা শুরুর স্টেশন">From Station</label>
                        <div class="ca-input-with-icon ca-custom-dropdown" id="ca-origin-station-dropdown">
                            <i class="fas fa-train ca-input-icon"></i>
                            <input type="text" id="ca-origin-station-input" placeholder="Select from station" class="translatable-placeholder" data-bn-placeholder="স্টেশন নির্বাচন করুন"
                                autocomplete="off" readonly>
                            <input type="hidden" id="ca-origin-station" name="ca_origin_station">
                            <div class="ca-dropdown-menu" id="ca-origin-station-menu" style="display: none;">
                                <div class="ca-dropdown-options" id="ca-origin-station-options">
                                    {% for station in stations %}
                                    <div class="ca-dropdown-option" data-value="{{ station }}">{{ station }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="ca-error-message translatable" id="ca-origin-station-error" data-bn="যাত্রা শুরুর স্টেশন আবশ্যক">From station is required</span>
                    </div>
                    <div class="swap-icon-wrapper" id="ca-swap-button" title="Swap stations">
                        <i class="fas fa-exchange-alt swap-icon"></i>
                    </div>
                    <div class="ca-form-group">
                        <label for="ca-destination-station-input" class="translatable" data-bn="গন্তব্য স্টেশন">To Station</label>
                        <div class="ca-input-with-icon ca-custom-dropdown" id="ca-destination-station-dropdown">
                            <i class="fas fa-train ca-input-icon"></i>
                            <input type="text" id="ca-destination-station-input" placeholder="Select to station" class="translatable-placeholder" data-bn-placeholder="গন্তব্য স্টেশন নির্বাচন করুন"
                                autocomplete="off" readonly>
                            <input type="hidden" id="ca-destination-station" name="ca_destination_station">
                            <div class="ca-dropdown-menu" id="ca-destination-station-menu" style="display: none;">
                                <div class="ca-dropdown-options" id="ca-destination-station-options">
                                    {% for station in stations %}
                                    <div class="ca-dropdown-option" data-value="{{ station }}">{{ station }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="ca-error-message translatable" id="ca-destination-station-error" data-bn="গন্তব্য স্টেশন আবশ্যক">To station is required</span>
                    </div>
                </div>
                <div class="ca-form-group ca-submit-btn">
                    <button type="submit" class="ca-btn-primary translatable" data-bn="প্রাপ্যতা দেখুন">
                        <i class="fas fa-search"></i> Check Availability
                    </button>
                </div>
                <p class="ca-info-text translatable-html" data-bn='<i class="fas fa-info-circle"></i> টিকিটের তথ্য সর্বশেষ ম্যাট্রিক্সের উপর ভিত্তি করে দেখানো হচ্ছে। সবচেয়ে সঠিক ও আপডেটেড ফলাফল পেতে, পুনরায় ম্যাট্রিক্স তৈরী করুন।'>Ticket availability is shown based on the last matrix you generated. For the most accurate and updated results, please generate the matrix again.</p>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    <script src="/static/js/scripts.js"></script>
</body>

</html>